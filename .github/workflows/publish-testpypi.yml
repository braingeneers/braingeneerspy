name: Publish to PyPI Test Server

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  publish:
    runs-on: ubuntu-latest

    # Extra safety: ensure we only ever run for master base/ref
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'master')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need tags + history for version calc

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Compute version from git tags
        id: version
        run: |
          set -e

          # Latest *stable* tag of form X.Y.Z
          TAG=$(git describe --tags --match "[0-9]*.[0-9]*.[0-9]*" --abbrev=0 2>/dev/null || true)

          if [ -z "$TAG" ]; then
            echo "No base tag matching X.Y.Z found. Refusing to publish."
            exit 1
          fi

          echo "Base tag: $TAG"

          # Commits since that tag
          COMMITS_SINCE=$(git rev-list "${TAG}..HEAD" --count)
          echo "Commits since base tag: $COMMITS_SINCE"

          BASE_VERSION="$TAG"

          # Zero-pad build number: 0000, 0001, ...
          printf -v BUILD "%04d" "$COMMITS_SINCE"

          VERSION="${BASE_VERSION}.${BUILD}"
          echo "Computed version: $VERSION"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Inject computed version into pyproject.toml
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "Injecting version $VERSION into pyproject.toml"

          python - << 'EOF'
          import os
          import pathlib
          import re

          version = os.environ["VERSION"]
          pyproject = pathlib.Path("pyproject.toml")
          text = pyproject.read_text()

          pattern = r'(?m)^(version\s*=\s*")[^"]*(")'

          def repl(match):
              return f'{match.group(1)}{version}{match.group(2)}'

          new_text, count = re.subn(pattern, repl, text)
          if count == 0:
              raise SystemExit('Did not find a version = "..." line in pyproject.toml')

          pyproject.write_text(new_text)
          print(f'Set version = "{version}" in pyproject.toml')
          EOF
        env:
          VERSION: ${{ steps.version.outputs.version }}

      - name: Build package
        run: |
          python -m build

      - name: Publish to TestPyPI
        # Only actually upload on push to master, not on PRs
        if: github.event_name == 'push'
        uses: pypa/gh-action-pypi-publish@v1.9.0
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
