name: Publish to PyPI

on:
  push:
    branches: [master]
    tags:
      - '*.*.*'         # Github tag format for braingeneerpy repo formatted as in this example, "0.3.1"
  release:
    types: [published]
  pull_request:
    branches: [master]

jobs:
  publish:
    runs-on: ubuntu-latest

    # Extra safety: only run when base is master
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'master')

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # IMPORTANT: we need full history for tags + commit count

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Get latest tag (X.Y.Z)
        id: tag
        run: |
          set -e
          # Use latest tag matching X.Y.Z; adjust pattern if you use "vX.Y.Z" tags instead
          if git describe --tags --match '*.*.*' >/dev/null 2>&1; then
            TAG=$(git describe --tags --match '*.*.*' --abbrev=0)
          else
            # Fallback if no tags yet
            TAG="0.0.0"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Compute version from tag and commit count
        id: version
        run: |
          set -e
          TAG="${{ steps.tag.outputs.tag }}"

          if [ "$TAG" = "0.0.0" ]; then
            COUNT=$(git rev-list --count HEAD)
          else
            COUNT=$(git rev-list --count "$TAG"..HEAD)
          fi

          VERSION="${TAG}.${COUNT}"

          echo "Using version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Patch version into pyproject.toml
        run: |
          python - << 'PY'
          from pathlib import Path
          import os, re

          version = os.environ["VERSION"]
          path = Path("pyproject.toml")
          text = path.read_text(encoding="utf-8")

          # Replace the first 'version = "..."' line in [project]
          new_text, n = re.subn(
              r'(?m)^version\s*=\s*".*"', 
              f'version = "{version}"',
              text,
              count=1,
          )
          if n == 0:
              raise SystemExit("Did not find a version = \"...\" line to replace in pyproject.toml")

          path.write_text(new_text, encoding="utf-8")
          PY

      - name: Build package
        run: |
          python -m build

      - name: Publish to PyPI
        if: github.event_name == 'push'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
